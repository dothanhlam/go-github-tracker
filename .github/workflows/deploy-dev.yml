name: Deploy to Dev

on:
  push:
    branches: [ dev ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true

    - name: Download dependencies
      run: go mod download

    - name: Run tests
      run: go test $(go list ./internal/... | grep -v '/internal/mcp') -v -coverprofile=coverage.out -covermode=atomic

    - name: Test summary
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        go tool cover -func=coverage.out >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Build & Deploy Lambda
    runs-on: ubuntu-latest
    needs: test   # only deploy if tests pass
    environment: dev

    permissions:
      id-token: write   # required for OIDC auth
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true

    - name: Download dependencies
      run: go mod download

    - name: Build Lambda binary (ARM64)
      run: |
        chmod +x scripts/build-lambda.sh
        ./scripts/build-lambda.sh

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
        aws-region: ap-southeast-1

    - name: Deploy Lambda function
      run: |
        aws lambda update-function-code \
          --function-name dora-metrics-dev-collector \
          --zip-file fileb://lambda-deployment.zip \
          --region ap-southeast-1

    - name: Wait for Lambda update to complete
      run: |
        aws lambda wait function-updated \
          --function-name dora-metrics-dev-collector \
          --region ap-southeast-1

    - name: Deployment summary
      run: |
        echo "## ðŸš€ Deployment to Dev" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Function**: \`dora-metrics-dev-collector\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: \`ap-southeast-1\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
